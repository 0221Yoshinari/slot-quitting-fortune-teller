import streamlit as st
import random

# --- 定義データ ---
# 質問項目と選択肢、および内部的なスコア付け
# スコアは例であり、表示パターンに影響します
QUESTIONS_DATA = [
    {
        "question": "今日の台とのつながり具合は？",
        "options": {"運命共同体": 5, "ソウルメイト": 3, "微妙な距離感": 0, "赤の他人": -5},
        "key": "q1_tsunagari"
    },
    {
        "question": "あなた自身のエスパー度合いは？",
        "options": {"裏モノ感知": 5, "ゾーンが見える": 3, "なんとなく分かる": 1, "全然分からない": -2},
        "key": "q2_esper"
    },
    {
        "question": "現在の台の調子はどう感じますか？",
        "options": {"絶好調！GOGOが止まらない": 5, "まあまあ、これから": 2, "波が荒い": -1, "どん底、地獄の業火": -5},
        "key": "q3_cond"
    },
    {
        "question": "過去に「やめて大失敗（後任者が大噴き）」の経験はありますか？",
        "options": {"はい、吐きそうです": -3, "はい、たまに": -1, "いいえ、常に完璧": 2, "いいえ、打たない": 0},
        "key": "q4_failure_exp"
    },
    {
        "question": "今まさに「やめ時」だと感じますか？",
        "options": {"はい、脳がそう指令する": -5, "いや、まだイケる": 2, "迷い中、助けてAI！": 0, "ヤメるという選択肢はない": 5},
        "key": "q5_feeling"
    },
    {
        "question": "財布の中身は残りいくら？",
        "type": "number_input",
        "min_value": 0, "max_value": 500000, "step": 1000, "value": 0,
        "score_bands": {50000: 5, 10000: 2, 1: 0, 0: -5}, # 5万円以上で5点, 1万円以上で2点, 1円以上で0点, 0円で-5点
        "key": "q6_wallet_money"
    },
    {
        "question": "閉店まであと何時間？",
        "type": "number_input",
        "min_value": 0, "max_value": 10, "step": 1, "value": 0,
        "score_bands": {5: 2, 3: 1, 1: 0, 0: -3}, # 5時間以上で2点, 3時間以上で1点, 1時間以上で0点, 0時間で-3点
        "key": "q7_closing_hours"
    },
    {
        "question": "隣の台は出玉爆発中ですか？",
        "options": {"はい、眩しい": -2, "はい、でも私の方が": 1, "いいえ、ドンマイ": 0, "いいえ、私も瀕死": -3},
        "key": "q8_neighbor"
    },
    {
        "question": "今日のパチ屋のトイレは綺麗でしたか？",
        "options": {"ピカピカ": 1, "普通": 0, "ちょっと…": -1, "行ってない": 0},
        "key": "q9_toilet"
    },
    {
        "question": "今日の運勢は？（来店前に占ったとして）",
        "options": {"大吉": 3, "吉": 2, "中吉": 1, "小吉": 0, "末吉": -1, "凶": -2, "大凶": -3},
        "key": "q10_fortune"
    },
    {
        "question": "GOGOランプに何かが宿っているのを感じますか？",
        "options": {"確信した": 4, "何となく": 2, "気のせい": 0, "見えない": -2},
        "key": "q11_gogo_aura"
    },
    {
        "question": "今日、店員さんが何回あなたの台に注目しましたか？",
        "type": "number_input",
        "min_value": 0, "max_value": 10, "step": 1, "value": 0,
        "score_bands": {3: 3, 1: 1, 0: 0}, # 3回以上で3点, 1回以上で1点, 0回で0点
        "key": "q12_staff_attention"
    },
    {
        "question": "あなたの後ろで、誰か台を待っていますか？",
        "options": {"はい、殺気を感じる": -3, "はい、チラ見": -1, "いいえ、快適": 1, "いいえ、私だけ": 0},
        "key": "q13_waiting"
    },
    {
        "question": "今日の最終目標出玉は何枚でしたか？",
        "type": "number_input",
        "min_value": 0, "max_value": 100000, "step": 100, "value": 0,
        "score_bands": {10000: 3, 5000: 2, 1000: 1, 0: -2}, # 1万枚以上で3点, 5千枚以上で2点, 1千枚以上で1点, 0枚で-2点
        "key": "q14_target_medals"
    },
    {
        "question": "今の台、愛せますか？",
        "options": {"愛してる！": 5, "まあまあ好き": 2, "嫌いになりそう": -2, "無理": -5},
        "key": "q15_love_machine"
    },
    {
        "question": "お昼ご飯、美味しかったですか？",
        "options": {"最高！": 1, "普通": 0, "まずかった": -1, "食べてない": -1},
        "key": "q16_lunch"
    },
    {
        "question": "家で待つ家族（ペット含む）の顔がちらつきますか？",
        "options": {"はい、天使の笑顔": -4, "はい、そろそろ": -2, "いいえ、まだ闘う": 2, "家族？何それ": 5},
        "key": "q17_family_face"
    },
    {
        "question": "最終ボーナスから100G以内で当たっていますか？",
        "options": {"はい、連荘中": 3, "はい、すぐに": 2, "いいえ、ハマり中": -2},
        "key": "q18_within_100g"
    },
    {
        "question": "今日のレバーオン、脳汁が出ましたか？",
        "options": {"毎日出る": 3, "たまに": 1, "今日はまだ": -1, "出ない": -3},
        "key": "q19_noujiru"
    },
    {
        "question": "このツールにどこまで従いますか？",
        "options": {"全面的に信頼！": 2, "参考程度": 1, "半信半疑": 0, "自分の感性が全て": -2},
        "key": "q20_trust_tool"
    },
]

# --- 結果メッセージのパターン（30個） ---
RESULT_MESSAGES = {
    "score_very_low": [ # 超ヤメ時！危険信号！ (例: -50点〜-30点)
        "🚨 **緊急速報！台があなたを嫌っています！** 今すぐ席を立ち、美味しいご飯を食べに行きましょう。後悔する前に！",
        "💀 **強制終了推奨！** このまま続行すると、明日の朝食はパンの耳だけになる未来が見えます。逃げて！",
        "🏃‍♂️ **Run！Run！Run！** あなたの背後に、ヤメの妖精が立っています。ダッシュで逃げましょう！",
        "🚫 **台からのレッドカード！** あなたの負けです。潔く席を立ち、遠くの景色でも眺めて心を落ち着かせましょう。",
        "💸 **財布が悲鳴を上げています。** 今すぐ席を立ち、銀行口座の残高を確認してください。手遅れになる前に！",
        "🌪️ **破滅の嵐が来ています！** 逃げてください、台があなたに牙を剥いています！",
        "👹 **魔界への扉が開いています！** その扉の向こうは、地獄です。絶対に入らないでください。",
        "👻 **幽霊があなたの肩を叩いています。** 『もう…ヤメロ…』と囁いていますよ？"
    ],
    "score_low": [ # ヤメ推奨！勇気ある撤退！ (例: -29点〜-10点)
        "👋 **お疲れ様でした！** この台はもう、あなたに微笑みかけることはないでしょう。次の台との出会いに期待しましょう。",
        "🚶‍♀️ **冷静な判断こそ勝利への道。** 今日のところはこれくらいで勘弁してやりましょう。パチプロは引き際も肝心！",
        "🍵 **休憩タイムならぬ、退散タイム。** 一度ホールを出て、リフレッシュするのもアリですよ。リセットされてるかも？",
        "🔄 **心のリセットボタン、ポチッとな！** 次の機会に賭けて、今日は撤退しましょう。英断です。",
        "😈 **隣の台があなたを嘲笑っています。** 今すぐヤメて、心の平穏を取り戻しましょう。ヤメれば勝てる日もある！",
        "📉 **台が『もう無理…』と囁いています。** その声を無視してはいけません。きっと神の声です。",
        "💤 **体力の限界！** あなたの集中力はもう限界です。眠気と戦うのは、別の戦場で。",
        "✉️ **謎のメッセージ『ヤメ』。** あなたの第六感が、そう告げている気がしませんか？"
    ],
    "score_neutral": [ # 迷い中…熟考を！ (例: -9点〜+9点)
        "🤔 **思考は深い沼。** この台はあなたを試しています。もう一度、己の感性とデータを見つめ直しましょう。",
        "⚖️ **天秤は揺れています。** 続行かヤメか…あなたの選んだ道が、今日の運命を決めます。後悔なき選択を！",
        "🎲 **運命のサイコロを振ってみますか？** 続けるも地獄、ヤメるも地獄…いや、そうでもないかも？",
        "🧘‍♀️ **無の心でレバーを叩け。** 邪念を捨てて打てば、GOGOランプが光る…かもしれません。",
        "🔮 **おみくじ結果は「吉」。** どちらに転ぶか分かりませんが、あなたの行動次第で未来は変わる！コンビニで甘いものでも買って考え直せ！",
        "🌈 **GOGOランプが、まだ見ぬ未来を暗示している…かも？** あと100Gだけ、試してみては？きっと何かが見える！",
        "🍀 **運命は五分五分。** 己の感性を信じるか、それとも現実を見るか…全てはあなた次第です。",
        "☕ **一度冷静になりましょう。** ホール内のカフェで一息入れてから、最終決断を。意外な閃きがあるかも？"
    ],
    "score_high": [ # 続行推奨！チャンス到来！ (例: +10点〜+29点)
        "💪 **まだ戦える！** その台はあなたに「まだイケる！」と語りかけています。粘り勝ちを狙いましょう。",
        "📈 **上昇気流に乗れ！** 今日のあなたは、パチスロの神に愛されているかもしれません。この波を逃すな！",
        "💰 **諭吉があなたを呼んでいる！** このまま続行すれば、きっと財布がパンパンになるでしょう。夢を掴め！",
        "✨ **GOGOランプがあなたの心に輝きを放つ。** 勝利の予感がしますね！このチャンスを逃す手はありません！",
        "🦸‍♂️ **あなたのエスパー能力が目覚める時！** 今こそ、その超能力を解放しましょう！",
        "🏆 **勝利の女神が微笑んでいる！** このまま続行して、伝説を作ってください！",
        "🚀 **ロケットスタートの予感！** ここからが本当の勝負です。目指せ万枚！"
    ],
    "score_very_high": [ # 超続行！神がかり！ (例: +30点以上)
        "🔥 **止め打ち厳禁！** その台はあなたを裏切らないでしょう。勝利の雄叫びを上げましょう！閉店まで全ツッパ！",
        "👑 **KING OF JUGGLER！** 今日のあなたは無敵です。設定6を掴んだかもしれません！最高の瞬間を味わい尽くせ！",
        "🤩 **脳汁大放出警報発令中！** その台はあなたのモノです。閉店まで全ツッパしましょう！隣の視線も気にせず！",
        "💫 **神の領域へようこそ。** あなたのパチスロ人生で最高の瞬間が訪れています。この奇跡を思う存分味わいましょう！"
    ]
}

# --- Streamlit UI 部分 ---

st.set_page_config(
    page_title="パチスロやめ時おみくじツッパ！",
    layout="centered",
    initial_sidebar_state="collapsed", # サイドバーはデフォルトで閉じる
    page_icon="🔮" 
)

st.title("🎰 パチスロやめ時おみくじツッパ！ 🎰")

st.markdown(
    """
    **今打ってる台のやめ時を一発で判定！**
    やめるか、やめないか悩んでいるそこのあなた。
    このツールの結果を判断材料にしてみてはいかが？
    ---
    """
)

st.header("▼質問に答えて、あなたの『やめ時』を占おう！▼")
st.markdown("正直に、直感で答えるのがポイントです！")

user_answers = {}
total_score = 0

with st.container(border=True):
    for i, q_data in enumerate(QUESTIONS_DATA):
        st.markdown(f"##### Q{i+1}. {q_data['question']}")
        
        if q_data.get("type") == "number_input":
            answer = st.number_input(f"{q_data['question']} (数値入力)", 
                                     min_value=q_data.get("min_value", 0), 
                                     max_value=q_data.get("max_value", None), 
                                     value=q_data.get("value", 0), 
                                     step=q_data.get("step", 1), 
                                     key=q_data['key'])
            
            # スコアバンドに基づいてスコアを決定
            score = 0
            sorted_bands = sorted(q_data['score_bands'].items(), reverse=True) # 閾値が高い順
            for threshold, band_score in sorted_bands:
                if answer >= threshold:
                    score = band_score
                    break
            
        else: # selectbox (default)
            options_list = list(q_data['options'].keys())
            answer = st.selectbox("選択肢を選んでください", options_list, key=q_data['key'])
            score = q_data['options'].get(answer, 0) # 選択肢に対応するスコアを取得
        
        user_answers[q_data['key']] = answer
        total_score += score
        
        st.markdown("---") # 各質問の区切り線

st.markdown("### さあ、あなたのやめ時は！？")
predict_button = st.button("🔮 やめ時を占う！", type="primary")

if predict_button:
    # スコアに基づいたメッセージ選択
    # 質問スコアの合計範囲を考慮して調整
    # 最小スコア: -5*13 = -65 (選択肢系) + (数値系最低) -5*3 = -15. くらい
    # 最大スコア: 5*13 = 65 + (数値系最高) 5*3 = 15. くらい
    # 総質問数20個で、選択肢が13個、数値が7個(スコアバンドが4つあるものもあるので調整)
    # 大体 -50 ~ +50 くらいの範囲と仮定

    if total_score >= 30: # 非常に高いスコア
        result_category = "score_very_high"
    elif total_score >= 10: # 高いスコア
        result_category = "score_high"
    elif total_score >= -10: # 中間（ニュートラル）スコア
        result_category = "score_neutral"
    elif total_score >= -30: # 低いスコア
        result_category = "score_low"
    else: # 非常に低いスコア
        result_category = "score_very_low"
    
    selected_message = random.choice(RESULT_MESSAGES[result_category])
    
    st.subheader("▼おみくじ結果▼")
    st.markdown(f"## {selected_message}")
    st.markdown(f"（合計スコア: {total_score}点）")
    st.info("※この結果はあくまでおふざけです。遊技は自己責任でお願いします！")